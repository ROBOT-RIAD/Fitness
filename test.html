<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Health & Fitness Chatbot</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 30px auto;
      padding: 0 15px;
    }
    h2 {
      text-align: center;
      color: #333;
    }
    #chatbox {
      border: 1px solid #ccc;
      padding: 15px;
      height: 500px;
      overflow-y: auto;
      background: #f9f9f9;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #inputForm {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }
    #messageInput {
      flex: 1;
      padding: 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #sendBtn {
      padding: 10px 20px;
      font-size: 1rem;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #sendBtn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .user {
      color: #007bff;
      margin: 10px 0;
      font-weight: bold;
    }
    .bot {
      color: #333;
      margin: 10px 0;
      white-space: pre-wrap;
      background: #fff;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .error {
      color: #dc3545;
      font-style: italic;
    }
    .loading {
      color: #6c757d;
      font-style: italic;
    }
  </style>
</head>
<body>

<h2>Health & Fitness Chatbot</h2>

<div id="chatbox"></div>

<form id="inputForm">
  <input type="text" id="messageInput" placeholder="Ask about today's meal plan..." autocomplete="off" required />
  <button type="submit" id="sendBtn">Send</button>
</form>

<script>
  const chatbox = document.getElementById('chatbox');
  const form = document.getElementById('inputForm');
  const input = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');

  // Load or generate session ID
  let sessionId = localStorage.getItem('chatSessionId');
  if (!sessionId) {
    sessionId = Date.now().toString();
    localStorage.setItem('chatSessionId', sessionId);
  }

  // Retrieve authentication token (JWT)
  const authToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzU1MzQ5Mzg0LCJpYXQiOjE3NTUzMzQ5ODQsImp0aSI6IjU1YmU1YTA3YmU4OTQ1YTZhODJlYjM5YmQxYTAzMGNhIiwidXNlcl9pZCI6MTI1LCJpZCI6MTI1LCJlbWFpbCI6InRlc2RkdEBnbWFpbC5jb20iLCJyb2xlIjoidXNlciJ9.HNH3A4XP4SWUi8sTgm9tInNafYagzSqmJoQBaetxe7I';

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = input.value.trim();
    if (!message) return;

    appendMessage('user', `You: ${message}`);
    input.value = '';
    input.disabled = true;
    sendBtn.disabled = true;

    const placeholder = appendMessage('bot', 'Loading...');

    try {
      const headers = {
        'Content-Type': 'application/json',
      };

      // Add JWT Bearer token if available
      if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
      }

      const response = await fetch('http://10.10.13.26:9001/chat/Ai/', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({
          message: message,
          session_id: sessionId,
        }),
      });

      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }

      const reader = response.body.getReader();
      const decoder = new TextDecoder('utf-8');
      let botMessage = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value, { stream: true });
        botMessage += chunk;
        updateBotMessage(placeholder, botMessage);
      }

      // Check if the response contains an error
      if (botMessage.startsWith('[ERROR]')) {
        placeholder.classList.add('error');
      }

    } catch (error) {
      updateBotMessage(placeholder, `[Error] Failed to fetch response: ${error.message}. Please check your connection or login status.`);
      placeholder.classList.add('error');
    } finally {
      input.disabled = false;
      sendBtn.disabled = false;
      input.focus();
    }
  });

  function appendMessage(sender, text) {
    const msgElem = document.createElement('div');
    msgElem.className = sender;
    msgElem.textContent = text;
    chatbox.appendChild(msgElem);
    chatbox.scrollTop = chatbox.scrollHeight;
    return msgElem;
  }

  function updateBotMessage(element, text) {
    element.textContent = `Bot: ${text}`;
    element.classList.remove('loading');
    chatbox.scrollTop = chatbox.scrollHeight;
  }

  // Display welcome message
  appendMessage('bot', 'Welcome to the Health & Fitness Chatbot! Ask about your meal plan for today (August 2, 2025) or any health-related question.');
</script>

</body>
</html>
